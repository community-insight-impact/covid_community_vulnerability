import pandas as pd

URL = 'https://raw.githubusercontent.com/PMMAraujo/covid_community_vulnerability/master/data/merged_data.csv'
TEST_DATA = './data/merged_data.csv'

BASE_DF = pd.read_csv(URL, index_col=0, dtype={'FIPS': object})
TEST_DF = pd.read_csv(TEST_DATA, index_col=0, dtype={'FIPS': object})

def test_new_data():
    """
    Test if the "merged_data.csv" file submited in the pull request has any
    new columns when compred to its current version in the repository
    """
    not_in_base = [x for x in TEST_DF.columns if x not in BASE_DF.columns]
    n_new_cols = len(not_in_base)

    assert n_new_cols >= 1, f"There are now new columns"

def test_absent_cols():
    """
    Test if the "merged_data.csv" file submited in the pull request has all the
    columns present in its current version in the repository
    """
    not_in_test = [x for x in BASE_DF.columns if x not in TEST_DF.columns]
    n_missing_cols = len(not_in_test)

    assert n_missing_cols < 1, \
    f"""
    There are/is {n_missing_cols} missing columns comparing to previous
    dataset versions
    Missing columns: {[x for x in not_in_test]}
    """

def test_fips_present():
    """
    Test if the "merged_data.csv" file submited in the pull request has all the
    FIPS codes (rows) as in its current version in the repository
    """
    fips_missing = [x for x in BASE_DF['FIPS'].values if x not in\
                    TEST_DF['FIPS'].values]
    n_missing_fips = len(fips_missing)

    assert n_missing_fips < 1, \
    f"""
    There are/is {n_missing_fips} missing FIPS in the dataset
    FIPS missing: {[x for x in fips_missing]}
    """

def test_missing_values():
    """
    Test if the "merged_data.csv" file submited in the pull request has columns
    with missing data.
    """
    cols_with_missing = {k for (k,v) in TEST_DF.isna().sum().to_dict().items() if v > 0}
    n_cols_with_missing = len(cols_with_missing)

    assert n_cols_with_missing < 1, \
    f"""
    There are/is {n_cols_with_missing} column(s) with missing data.
    Columns with missing data: {[x for x in cols_with_missing]}
    """

